<html>
 <head>
	<link rel="stylesheet" href="/css/first.css" type="text/css" />
	<title>Adding Ajax</title>
	<style type="text/css" media="screen">
	 	
		.header {
			display: block;
			overflow: hidden;
			height: 70px;
			padding-left:120px;
			padding-top:3px;
		}
		
		.container{
			width: 1000px;
			overflow: hidden;
		}
		
		
		
		#main {
			background-color: white;
			border-color: #CED5E0;
			-webkit-border-radius: 4px;
			-moz-border-radius: 4px;
			border-radius: 4px;
			display: block;
			-moz-box-shadow: 0 1px 5px rgba(0, 0, 0, .15);
			-webkit-box-shadow: 0 1px 5px rgba(0, 0, 0, .15);
			box-shadow: 0 1px 5px rgba(0, 0, 0, .15);
			border: 1px #D5D5D5 solid;
			width:780px;
			margin-left:178px;
			margin-bottom:20px;
			z-index:200;
			opacity:0.8;
		}
		
		#inner{
			/*margin:10px;*/
		}
		
		ul li{
			list-style:none;
		}
		
		#sidebar0{
			width:180px;
			float:left;
			padding-top:10px;
		}
		
		#sidebar0 ul li{
			list-style:none;
		}
		
		#sidebar0 ul li.active {
			border:1px solid transparent;
			border-right:none !important;
			-webkit-border-top-left-radius: 5px;
			-webkit-border-bottom-left-radius: 5px;
			-moz-border-radius-top-left: 5px;
			-moz-border-radius-bottom-left: 5px;
			border-top-left-radius: 5px;
			border-bottom-left-radius: 5px;
			background: white;
			*background: none;
			*font-weight:bold;
			-moz-box-shadow: -5px 1px 5px 0px rgba(0, 0, 0, .15);
			-webkit-box-shadow: -3px 1px 5px .5px rgba(0, 0, 0, .15);
			box-shadow: -5px 1px 5px 0px rgba(0, 0, 0, .15);
			list-style:none;
			opacity:0.7;
			font-weight:bold;
		}
		
		
		
		li.active-grey{
			background:#FAFAFA !important;
		}
		
		#sidebar0 ul li a{
			text-align: right;
			display: block;
			padding: 18px ;
			font-size: 12px;
			text-decoration: none;
			padding-right: 20px;
			padding-top:15px;
		}
		
		#sidebar0 ul li.active a{
			padding-top:18px;
		}
		
		ul li a{
			text-align: right;
			display: block;
			font-size: 12px;
			text-decoration: none;
			padding-right: 20px;
			padding-bottom:8px;
		}
		
		a {
			color: #525252;
			/*text-decoration: none;*/
		}
		
		a.selected{
			font-weight: bold;
			color: #5092BD;
		}
		
		ul li a.selected{
			background:#666;
			color:white;
		}
		
		.text-title, .title-text {
			margin-top: 24px;
			color: #393;
			font-size: 16px;
			font-family: 'lucida grande',verdana;
		}
		
		
		.text-text {
			font-size: 13px;
			padding-left: 20px;
			margin-top: 10px;
			line-height: 18px;
		}
		pre, .output {
			color: #333;
			background: #EEE;
			-moz-border-radius: 5px;
			-webkit-border-radius: 5px;
			border: 1px solid #DFE0CD;
			padding: 10px;
			margin-top:4px;
			font-family: Consolas, monospace;
		}
		
		ul.inner{
			padding-left:0px !important;
		}
	</style>
	<script type="text/javascript">
			  var _gaq = _gaq || [];
			  _gaq.push(['_setAccount', 'UA-19500723-1']);
			  _gaq.push(['_trackPageview']);

			  (function() {
			    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			  })();

			</script>
</head>
<body> 
	<div class="header" align="center">
			<div class="container" align="left">
				<table width="100%">
					<tr>
						<td align="left"><img src="/images/tales_logo.png" /></td>
						<td align="right" style="line-height:50px; padding-right:110px;">
							 <a href="http://help.talesframework.org/discussions/discuss">Discuss or ask a question</a>
						</td>
					<tr>
				</table>
			</div>
	</div>
	<div align="center">
		<div class="container" align="left" >
				
			<div id="sidebar0" style="float:left;margin-right:0px;">
					<ul>
							<li >
								<a href="/" >Home</a>
							 </li>
					</ul>
					
					<div style="text-align:right; font-weight:bold;margin-right:20px; color:#393;font-size:13px;">
							The Basics
					</div>
					<ul>
						 	<li talesId="firstApp" >
								<a href="/install-tales" >Install and make Your first app</a>
							 </li>
							<li talesId="examples">
								<a href="http://examples.talesframework.org/" >Examples</a>
							  </li>
							<li talesId="ide" >
								<a href="/eclipse" >IDE setup</a>
							 </li>
							<li talesId="gf"  class="active" >
								<a href="/gf-intro" class="">A more complete application</a>
							 </li>
							<li talesId="anatomy" >
								<a href="/anatomy" class="">App Directory structure</a>
							 </li>
						</ul>
						<div align="right">
						<div style="text-align:right; border-top:1px solid #ccc; padding-top:10px; font-weight:bold;margin-right:20px; color:#393;font-size:13px; width:120px;">
								Docs
						</div>
						</div>
						<ul>
							<li talesId="howtos" >
								<a href="/templating" >Tales</a>
							 </li>	
							<!--
							<li talesId="templating">
								<a href="/templating" >Templating</a>
							 </li>
							 <li talesId="routing">
								<a href="/routing">Routing</a>
							  </li>
							-->
								<li talesId="fanquery" >
									<a href="/what-is-fanquery" class="">Fanquery</a>
								 </li>
								<li talesId="fanbatis" >
									<a href="/fanbatis" class="">Fanbatis</a>
								 </li>
							</ul>
			 </div>
				<div id="main">
					<div id="inner" >
						<html>
	<head>
			
			<style type="text/css" media="screen">
				div.desc{
					color:#555;
					font-size:12px;
					line-height:15px;
				}
				ol{
					padding-left:20px;
					padding-right:10px;
				}
				.example-link{
					line-height:18px;
					padding-top:10px;
					border-bottom:1px dashed #ccc;
				}
				
				a.selected{
					color:#5092BD !important;
					font-weight:bold;
					background:none !important;
				}
				
				ol.inner li{
					padding-top:20px;
				}
			</style>
	</head>
	<body>
			<div style="overflow:hidden;">
					<table width="100%" cellspacing="0" cellpadding="0">
						<tr>
							<td valign="top" style="width:150px;background:#FAFAFA;height:200px;padding:10px;border-right:1px solid #eee">
								<ul class="inner">
									<li>
										<a class="example-link " talesId="intro" href="/gf-intro">The girlfriend app</a>
										
									</li>
									<li>
										<a class="example-link " talesId="install" href="/gf-install">Install tales and get started</a>
									</li>
									<li>
										<a class="example-link " talesId="model" href="/gf-model">Creating tables and model classes</a>
									</li>
									<li>
										<a class="example-link " talesId="ui" href="/gf-ui">Creating the UI</a>
									</li>
									<li>
										<a class="example-link selected" talesId="ajax" href="/gf-ajax">Spurring up with Ajax</a>
									</li>
									<!--
									<li>
										<a class="example-link" talesId="detail" href="/gf-detail">Adding the detail page (understanding routes) </a>
									</li>
									-->
									<li>
										<a class="example-link " talesId="production" href="/gf-production">Deploying</a>
									</li>
								</ul>
							</td>
							<td valign="top" style="padding:10px;" align="left">
								<div talesId="child"><div style="padding:10px">
<div class="title-text">
Getting started with Fanquery
</div>
<div class="text-text">
Take a look at index.html again.

we have a textfield with id "name" and a button with id "add-gf". When "add-gf" button is clicked we need to  add a girlfriend row in the database with the name given in the name text box. Create a IndexJs.fan with the following code
</div>
<div class="text-text">
<strong style="color:#666">fan/IndexJs.fan</strong>
<pre>
using fanquery
using tales 

@Js
@Include{plugins = [Plugin{name = "fanquery"}]}
class IndexJs{
  Void main(){
    Jq.ready{
      domReady
    }
  } 

  Void domReady(){
    Jq("#add-gf").click{
      Str name := Jq("#name").getVal
      Win.cur.alert(name)
    }
  }
}</pre>
</div>
<div class="text-text">
Take a look at the code above. In tales, Javascript can be written in fantom( which compiles to javascript and executes on browser).  Also fanquery is a library that will let us use all of the jquery awesomeness in fantom.[ Note however that not everything needs to be written in fantom. You can still use pure javascript if you want to. Just include script files in a &lt;script> tag in your html. This is very useful for all the "design-level" or off the shelf javascript where rewriting in fantom does not make sense]. 
</div>
<div class="text-text">
  Next we need to modify the page class and ask it to use this js, You use the html.jsMain() method to do it. Here's the full source code of Index.fan now.
</div>

<div class="text-text">
<strong style="color:#666;">fan/app/Index.fan </strong>
<pre>using tales 
using fanbatis

class Index : Page{
 <span style="color:#666">@Route{uri="/gf"}</span>  
 Void main(){
    GirlFriend[] friends := Db.list(GirlFriend{})
    html := Html("template/Index.html")
    rows := html.tag("rows").repeat(friends.size)
    rows.each|Tag oneRow, Int index|{
      oneFriend := friends[index]
      oneRow.tag("name").text(oneFriend.name)
                .attr("href","/gf/${oneFriend.id}")
    }
    html.tag("count").text("$friends.size")
    <strong>html.jsMain(IndexJs#)</strong>
		response.writeTag(html)
 }
}</pre>
</div>
<div class="text-text">
  Now go to http://localhost:8000/gf in your browser  and click the "add-gf" button you should see an alert.
</div>


<div class="title-text">
  Adding Ajax code and learning about "cut-and-send"
</div>
<div class="text-text">
  Let's add code to our page class that will take the Ajax request
</div>

<div class="text-text">
<strong style="color:#666;">fan/app/Index.fan </strong>
<pre>using tales 

class Index : Page{
 <span style="color:#666">@Route{uri="/gf"}</span>  
 Void main(){
   ..
 }
 
 <strong style="color:#666">@Route{uri="/add-gf"}</strong>
 <strong>Void addGf(Str name){</strong>
   <strong>GirlFriend gf := Db.create(GirlFriend{it.name = name})</strong>
   <strong>rowsTag := Html("template/examples/GfList.html").cutAt("rows")</strong>
   <strong>rowsTag.tag("name").text(gf.name).attr("href", "/gf/${gf.id}")</strong>
   
   <strong>html := rowsTag.apply</strong>
   <strong>response.writeStr(html)</strong>
 <strong>}</strong>
}</pre>
</div>


<div class="text-text">
  Let's go through that code in method "addGf" line by line
  <ol>
    <li>The method defines a route. It can take an argument name</li>
    <li>The first line creates a Gf row in database</li>
    <li>The second line creates an html instance, but cut's it at talesId "rows"</li>
    <li>Then we find the tag with talesId "name" inside that tag and add the "href" attr</li>
    <li>The apply method gives the html for that current tag</li>
    <li>Then we write html to the response</li>
  </ol>
</div>

<div class="text-text">
  Take another look at "cutAt" method and how it's used. This is called "cut-and-send" in tales and it's extremely useful in cases like this where you want take out a portion of html and dynamically insert it using ajax 
</div>

<div class="title-text">
  Writing Js code code to make Ajax call
</div>

<div class="text-text">
Let's modify the IndexJs to take the HTML back and just do a "prepend" 
<pre>
using fanquery
using tales 

@Js
class IndexJs{
  Void main(){
    Jq.ready{
      domReady
   }
  } 

  Void domReady(){
    Jq("#add-gf").click|cur, event|{
      if(name.trim == "")
        return
        
      <strong>HttpReq{it.uri=`/add-gf`}.postForm(["name" : name])|HttpRes res| {</strong>
          <strong>Jq("#all-gfs").prepend(Jq(res.content))</strong>
          <strong>Jq("#name").setVal("")</strong>
      <strong>}</strong>
    }
  }
}</pre>
</div>
<div class="text-text">
  Lets take a look at the above code
  <ol>
    <li>We make an http request to uri "/add-gf" with post parameter "name"</li>
    <li>It get routed to the addGf() method in the Index.fan class returning the html</li>
    <li>res.content returns html returned by server</li>
    <li>We prepend the result and clear the name field</li>
  </ol>
</div>

<div class="text-text">
We are done with the index page.. Let's add the <a href="/gf-production">detail page and deploy the application</a>
</div>
</div>
</div>
							</td>
						</tr>
					</table>
			</div>
	</body>
</html>
					</div>
				</div>
			 
		</div>
	</div>
</body>
</html>